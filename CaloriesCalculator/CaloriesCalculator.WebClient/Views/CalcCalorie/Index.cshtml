<!DOCTYPE html>
<html>
<head>
    <title>Калькулятор калорий</title>
</head>
<body>
    <h1>Калькулятор калорий</h1>

    <form>
        <table>
            <tr>
                <th>№</th>
                <th>Название</th>
                <th>Белки</th>
                <th>Жиры</th>
                <th>Углеводы</th>
            </tr>
            <tr>
                <td id="rowIndex">1</td>
                <td>
                    <input type="text" name="name" />
                    <select id="productList" style="display: none;"></select>
                </td>
                <td><input type="text" name="proteins" /></td>
                <td><input type="text" name="fats" /></td>
                <td><input type="text" name="carbs" /></td>
            </tr>
            <tr id="totalRow">
                <td></td>
                <td><input type="text" name="totalName" value="Итого" readonly /></td>
                <td><input type="text" name="totalProteins" /></td>
                <td><input type="text" name="totalFats" /></td>
                <td><input type="text" name="totalCarbs" /></td>
            </tr>
            <tr id="totalPer100gRow">
                <td></td>
                <td><input type="text" name="totalPer100gName" value="Итого на 100 грамм" readonly /></td>
                <td><input type="text" name="totalPer100gProteins" /></td>
                <td><input type="text" name="totalPer100gFats" /></td>
                <td><input type="text" name="totalPer100gCarbs" /></td>
            </tr>
        </table>
        <br />
        <button type="button" onclick="addNewRow()">Добавить новый продукт</button>
    </form>

    <script>
        var rowCount = 1;

        function updateAutocompleteEvents() {
            $('input[name="name"]').off('input');
            $('input[name="name"]').on('input', function () {
                var term = $(this).val();

                $.ajax({
                    url: '@Url.Action("SearchProducts", "CalcCalorie")',
                    type: 'GET',
                    data: { term: term },
                    success: function (data) {
                        var productList = $('#productList');
                        productList.empty();

                        data.forEach(function (product) {
                            var option = $('<option>');
                            option.val(product.id);
                            option.text(product.name);
                            productList.append(option);
                        });

                        productList.show();
                    }
                });
            });
        }

        function addNewRow() {
            var table = document.querySelector('table');
            var row = table.insertRow(-1);

            var cellIndex = row.insertCell();
            cellIndex.textContent = ++rowCount;

            var cellName = row.insertCell();
            cellName.innerHTML = '<input type="text" name="name" />';
            cellName.innerHTML += '<select class="product-list" style="display: none;"></select>';

            var cellProteins = row.insertCell();
            cellProteins.innerHTML = '<input type="text" name="proteins" />';

            var cellFats = row.insertCell();
            cellFats.innerHTML = '<input type="text" name="fats" />';

            var cellCarbs = row.insertCell();
            cellCarbs.innerHTML = '<input type="text" name="carbs" />';

            var totalRow = document.getElementById("totalRow");
            var totalPer100gRow = document.getElementById("totalPer100gRow");
            table.appendChild(totalRow);
            table.appendChild(totalPer100gRow);

            updateAutocompleteEvents();
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {
            updateAutocompleteEvents();

            $(document).on('change', '.product-list', function () {
                var selectedOption = $(this).find(':selected');
                var row = $(this).closest('tr');
                var proteinsInput = row.find('input[name="proteins"]');
                var fatsInput = row.find('input[name="fats"]');
                var carbsInput = row.find('input[name="carbs"]');

                proteinsInput.val(selectedOption.data('proteins'));
                fatsInput.val(selectedOption.data('fats'));
                carbsInput.val(selectedOption.data('carbs'));
            });
        });
    </script>

</body>
</html>